#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $DIR/default_environment.sh

shapefiledir=$INSTALL_DIR/etc/mapserver/shapefiles

function load_shapefile {
   url=$1
   shapefilename=$2
   tablename=$3
   srid=$4

   zipfile=$GIS_DATA_DIR/shapefiles/`echo $url | perl -pe 's/https?:\/\///'`

   if [ -f $zipfile ];
   then
       echo "already had zipfile $zipfile"
   else
       echo "need $zipfile"
       mkdir -p $GIS_DATA_DIR/shapefiles/
       (cd $GIS_DATA_DIR/shapefiles; wget -N -x $url)
   fi

   shapefile=$shapefiledir/$shapefilename

   if [ -f $shapefile ];
   then
       echo already had shapefile $shapefile
   else
       echo need shapefile $shapefile
       mkdir -p $shapefiledir
       unzip -o -j $zipfile -d $shapefiledir
   fi

   if ( psql -q -c "COPY (select table_catalog,table_name from information_schema.tables where table_name='$tablename') to stdout csv header"  | grep -qw $tablename ); 
   then
      echo "Already had table $tablename"
   else
      echo "Missing database table $tablename for $shapefile"
      mkdir -p /tmp/shp2pgsql
      shp2pgsql -I -s $srid $shapefile $tablename > /tmp/shp2pgsql/$tablename.sql
      psql -q < /tmp/shp2pgsql/$tablename.sql
   fi

   psql <<EOF
     DELETE FROM additional_layers where (layer,source) = ('$shapefilename','$url');
     INSERT INTO additional_layers (layer,source) values ('$shapefilename','$url');
     INSERT INTO additional_polygons (layer,label,color,tags,geom)
            SELECT '$shapefilename',
                   'TODO-fixme',
                   null,
                   null,
                   st_transform(geom,3857)
             FROM $tablename
EOF


}

load_shapefile http://data.openstreetmapdata.com/land-polygons-split-3857.zip  land_polygons.shp land_polygons 3857
load_shapefile http://data.openstreetmapdata.com/simplified-land-polygons-complete-3857.zip simplified_land_polygons.shp simplified_land_polygons  3857
load_shapefile http://www2.census.gov/geo/tiger/GENZ2014/shp/cb_2014_us_state_20m.zip cb_2014_us_state_20m.shp cb_2014_us_state_20m 4269
load_shapefile http://data.openoakland.org/sites/default/files/Oak_CommunityPoliceBeats_0.zip Oak_PoliceBeats.shp oak_policebeats 4326
load_shapefile 'http://gis.mdc.opendata.arcgis.com/datasets/689f41305d8b46d3b708113ce1444734_5.zip' Police_Grid.shp mdc_mdpd_police_grid 4326
load_shapefile 'http://gis.mdc.opendata.arcgis.com/datasets/ca807c842bca47cdac87fc880442150c_1.zip' Police_Station.shp mdc_police_stations 4326
# load_shapefile 'http://gis.mdc.opendata.arcgis.com/datasets/1f42ddb43bfb4fc2b98a5b14f06388a0_6.zip' Municipal_Police_Grid.shp mdc_municipal_police_grid 4326
# load_shapefile 'http://gis.mdc.opendata.arcgis.com/datasets/e9f4fcf584974b9996326186467a8a3e_0.zip' Municipal_Police_Station.shp  mdc_municipal_police_stations 4326

## # http://data.openoakland.org/group/public-safety TODO - double-check if OPD's is SRID 4326
#### If we have a correct land polygon file above, we don't need these water polygons (since everywhere
#### without land should be water).
####
#### However the April 18th land polygons from http://openstreetmapdata.com/data/land-polygons
#### were missing the great lakes, so these were temporarily added.
#load_shapefile http://data.openstreetmapdata.com/simplified-water-polygons-complete-3857.zip simplified_water_polygons.shp simplified_water_polygons 3857
#load_shapefile http://data.openstreetmapdata.com/water-polygons-split-3857.zip water_polygons.shp water_polygons 3857

# On our large memory physical servers, it was more efficient to
# render the large polygons directly from the shapefiles rather than
# loading them into a database.  If we want to go back to that
# approach, note that the shapefile cb_2014_us_state_20m.shp can not be
# rendered directly by mapserver, but if converted to another
# shapefile with the same information using ogr2ogr, it works.

[ -f $shapefiledir/states.shp ] || ogr2ogr -f "ESRI Shapefile"  $shapefiledir/states.shp  $shapefiledir/cb_2014_us_state_20m.shp
